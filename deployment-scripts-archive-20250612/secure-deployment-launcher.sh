#!/bin/bash

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                    üîê SECURE DEPLOYMENT LAUNCHER üîê                                  ‚ïë
# ‚ïë                                                                                       ‚ïë
# ‚ïë  This script provides multiple secure deployment options for your                     ‚ïë
# ‚ïë  OrphiCrowdFund contracts with maximum security.                                      ‚ïë
# ‚ïë                                                                                       ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${PURPLE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${PURPLE}‚ïë                    üîê SECURE DEPLOYMENT LAUNCHER üîê                                  ‚ïë${NC}"
echo -e "${PURPLE}‚ïë                                                                                       ‚ïë${NC}"
echo -e "${PURPLE}‚ïë  Choose your preferred deployment method with maximum security                        ‚ïë${NC}"
echo -e "${PURPLE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

echo ""
echo -e "${CYAN}üîê DEPLOYMENT OPTIONS:${NC}"
echo ""
echo -e "${GREEN}1. üíª Command Line + Temporary Private Key${NC}"
echo -e "   ‚Ä¢ Uses temporary private key (destroys after deployment)"
echo -e "   ‚Ä¢ All ownership immediately transferred to Trezor"
echo -e "   ‚Ä¢ Fast and automated"
echo -e "   ‚Ä¢ Requires 0.1 BNB in temporary wallet"
echo ""
echo -e "${GREEN}2. üåê Web Interface + MetaMask + Trezor${NC}"
echo -e "   ‚Ä¢ Maximum security with hardware wallet"
echo -e "   ‚Ä¢ No private keys ever stored"
echo -e "   ‚Ä¢ Requires MetaMask connected to Trezor"
echo -e "   ‚Ä¢ Manual confirmation for each transaction"
echo ""
echo -e "${GREEN}3. üìã Manual Deployment Instructions${NC}"
echo -e "   ‚Ä¢ Step-by-step guide for custom setup"
echo -e "   ‚Ä¢ Use your own tools and methods"
echo -e "   ‚Ä¢ Maximum flexibility"
echo ""

# Function to check if MetaMask is available (for option 2)
check_metamask() {
    if command -v google-chrome &> /dev/null || command -v brave &> /dev/null || command -v firefox &> /dev/null; then
        return 0
    else
        echo -e "${YELLOW}‚ö†Ô∏è  No supported browser found for MetaMask${NC}"
        return 1
    fi
}

# Function to check if private key is ready (for option 1)
check_private_key() {
    if grep -q "b367d8109b082413d2a23d69add6192d783d0f73bbfb3538f58cc5c28f7cd239" .env 2>/dev/null; then
        return 0
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Temporary private key not configured in .env${NC}"
        return 1
    fi
}

# Function to check wallet balance
check_balance() {
    local address="0x1AA54a6FaC73cdB09D7313Ef03060424662b26b1"
    echo -e "${BLUE}üí∞ Checking wallet balance...${NC}"
    
    # Use a simple curl command to check balance (BSC API)
    local balance_wei=$(curl -s "https://api.bscscan.com/api?module=account&action=balance&address=${address}&apikey=YourApiKeyToken" | grep -o '"result":"[^"]*' | cut -d'"' -f4)
    
    if [ ! -z "$balance_wei" ] && [ "$balance_wei" != "0" ]; then
        # Convert wei to BNB (divide by 10^18)
        local balance_bnb=$(echo "scale=4; $balance_wei / 1000000000000000000" | bc 2>/dev/null || echo "0")
        echo -e "${GREEN}‚úÖ Wallet balance: ${balance_bnb} BNB${NC}"
        return 0
    else
        echo -e "${RED}‚ùå Wallet has insufficient balance${NC}"
        return 1
    fi
}

echo -e "${CYAN}Please choose an option (1-3):${NC}"
read -p "Enter your choice: " choice

case $choice in
    1)
        echo ""
        echo -e "${BLUE}üîê Option 1: Command Line Deployment${NC}"
        echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        
        # Check if temporary private key is configured
        if check_private_key; then
            echo -e "${GREEN}‚úÖ Temporary private key configured${NC}"
            
            # Check balance
            if check_balance; then
                echo ""
                echo -e "${YELLOW}‚ö†Ô∏è  This deployment will:${NC}"
                echo -e "   ‚Ä¢ Use temporary private key for initial deployment"
                echo -e "   ‚Ä¢ Transfer ALL ownership to your Trezor immediately"
                echo -e "   ‚Ä¢ Destroy the temporary key after deployment"
                echo -e "   ‚Ä¢ Cost ~0.05 BNB in gas fees"
                echo ""
                read -p "Do you want to proceed? (y/N): " confirm
                
                if [[ $confirm =~ ^[Yy]$ ]]; then
                    echo ""
                    echo -e "${GREEN}üöÄ Starting secure deployment...${NC}"
                    
                    # Run pre-deployment checklist
                    echo -e "${BLUE}üîç Running pre-deployment checklist...${NC}"
                    if ./pre-deployment-checklist.sh; then
                        echo -e "${GREEN}‚úÖ Pre-deployment checks passed${NC}"
                        
                        # Execute deployment
                        echo ""
                        echo -e "${GREEN}üì¶ Deploying contracts...${NC}"
                        npx hardhat run --network mainnet scripts/deploy-secure-with-trezor-transfer.cjs
                        
                        if [ $? -eq 0 ]; then
                            echo ""
                            echo -e "${GREEN}üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!${NC}"
                            echo ""
                            echo -e "${YELLOW}üìù IMPORTANT: Next Steps${NC}"
                            echo -e "   1. Remove the temporary private key from .env"
                            echo -e "   2. Check SECURE_DEPLOYMENT_SUCCESS.json for contract addresses"
                            echo -e "   3. Verify contracts on BSCScan"
                            echo -e "   4. Test admin functions with your Trezor"
                            echo ""
                            
                            # Offer to clean up private key
                            read -p "Do you want to remove the temporary private key from .env now? (Y/n): " cleanup
                            if [[ ! $cleanup =~ ^[Nn]$ ]]; then
                                sed -i '' 's/DEPLOYER_PRIVATE_KEY=.*/DEPLOYER_PRIVATE_KEY=REMOVED_AFTER_DEPLOYMENT/' .env
                                echo -e "${GREEN}‚úÖ Temporary private key removed from .env${NC}"
                            fi
                        else
                            echo -e "${RED}‚ùå Deployment failed. Check the logs above.${NC}"
                        fi
                    else
                        echo -e "${RED}‚ùå Pre-deployment checks failed${NC}"
                    fi
                else
                    echo -e "${YELLOW}Deployment cancelled.${NC}"
                fi
            else
                echo -e "${RED}‚ùå Please fund the temporary wallet with 0.1 BNB:${NC}"
                echo -e "${YELLOW}   Address: 0x1AA54a6FaC73cdB09D7313Ef03060424662b26b1${NC}"
            fi
        else
            echo -e "${RED}‚ùå Temporary private key not found in .env${NC}"
            echo -e "${YELLOW}   The temporary key was generated earlier. Please check your .env file.${NC}"
        fi
        ;;
        
    2)
        echo ""
        echo -e "${BLUE}üåê Option 2: Web Interface Deployment${NC}"
        echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        
        if check_metamask; then
            echo -e "${GREEN}‚úÖ Browser detected${NC}"
            echo ""
            echo -e "${YELLOW}üìã Setup Instructions:${NC}"
            echo -e "   1. Install MetaMask browser extension if not installed"
            echo -e "   2. Connect your Trezor to MetaMask"
            echo -e "   3. Switch to BSC Mainnet in MetaMask"
            echo -e "   4. Ensure your Trezor has 0.1 BNB"
            echo ""
            read -p "Press Enter to open the web interface..."
            
            # Open the web interface
            if command -v open &> /dev/null; then
                open trezor-deployment-interface.html
            elif command -v xdg-open &> /dev/null; then
                xdg-open trezor-deployment-interface.html
            else
                echo -e "${YELLOW}Please manually open: trezor-deployment-interface.html${NC}"
            fi
            
            echo ""
            echo -e "${GREEN}üîê Web interface opened! Follow the steps in your browser.${NC}"
        else
            echo -e "${RED}‚ùå No supported browser found${NC}"
            echo -e "${YELLOW}Please install Chrome, Brave, or Firefox to use MetaMask${NC}"
        fi
        ;;
        
    3)
        echo ""
        echo -e "${BLUE}üìã Option 3: Manual Deployment${NC}"
        echo -e "${BLUE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        echo ""
        echo -e "${GREEN}üìñ Opening deployment guides...${NC}"
        
        # Show available guides
        echo ""
        echo -e "${CYAN}Available Documentation:${NC}"
        echo -e "   ‚Ä¢ TREZOR_DEPLOYMENT_INSTRUCTIONS.md"
        echo -e "   ‚Ä¢ TREZOR_DEPLOYMENT_OPTIONS.md"
        echo -e "   ‚Ä¢ FINAL_DEPLOYMENT_GUIDE.md"
        echo ""
        
        if command -v open &> /dev/null; then
            open TREZOR_DEPLOYMENT_INSTRUCTIONS.md
        elif command -v code &> /dev/null; then
            code TREZOR_DEPLOYMENT_INSTRUCTIONS.md
        else
            echo -e "${YELLOW}Please manually open: TREZOR_DEPLOYMENT_INSTRUCTIONS.md${NC}"
        fi
        ;;
        
    *)
        echo ""
        echo -e "${RED}‚ùå Invalid option. Please run the script again and choose 1, 2, or 3.${NC}"
        exit 1
        ;;
esac

echo ""
echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
echo -e "${PURPLE}                    üîê SECURE DEPLOYMENT LAUNCHER COMPLETE üîê${NC}"
echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
